# Post Mortem отчет: Восстановление работоспособности Linux-рервера с веб-приложением

## Описание инцидента

Инцидент проявился в полной недоступности веб-сайта по адресу http://18.196.71.81/. Доступ к ресурсу сопровождался сообщением об ошибке в конфигурационном файле проекта LocalSettings.php. Сервер функционировал в среде Amazon EC2 под управлением Linux.

Дата инцидента: 07/01/2026.  
Отчет утвержден: 07/01/2026.

## Хронология и шаги по устранению инцидента

### 1. Проверка доступности сайта и подтверждение заявленной неисправности

1.1. **Действие**: Подтверждение недоступности ресурса в браузере по адресу http://18.196.71.81/.  
1.2. **Результат**: Отображалась ошибка, указывающая на проблемы в конфигурационном файле LocalSettings.php. Это подтвердило необходимость системного вмешательства и перехода к диагностике на сервере.

### 2. Подключение к серверу и проверка статуса веб-сервера

2.1. **Действие**: Установление SSH-соединения с сервером:

```bash
ssh ec2-user@18.196.71.81
```

2.2. **Действие**: Проверка статуса веб-сервера:

```bash
sudo service httpd status
```

2.3. **Действие**: Перезапуск сервиса для исключения временных сбоев:

```bash
sudo service httpd restart
sudo service httpd status
```

2.4. **Результат**: Сервис httpd функционировал корректно (статус: active (running)), но перезапуск не устранил проблему с сайтом.

### 3. Попытка восстановления конфигурационного файла LocalSettings.php

3.1. **Действие**: Проверка резервной копии файла по пути /home/ec2-user/LocalSettings (5).php.  
3.2. **Действие**: Копирование файла в целевую директорию приложения.

```bash
cp LocalSettings\ \(5\).php /var/www/html/mediawiki/LocalSettings.php
```

3.3. **Результат**: Ошибка копирования из-за отсутствия свободного места на диске:

`cp: failed to extend '/var/www/html/mediawiki/LocalSettings.php': No space left on device`

Это указало на проблему с файловой системой, требующую дальнейшей диагностики.

### 4. Диагностика файловой системы и выявление причины исчерпания пространства

4.1. **Действие**: Проверка использования дискового пространства.

```bash
df -h
```

Комманда показала 100% заполнение дискового пространства.

4.2. **Действие**: Поиск файлов размером более 100 МБ для поиска аномально больших файлов.

```bash
sudo find / -type f -size +100M -exec du -h {} \;
```

4.3. **Результат**: Выявлен чрезмерно большой архив файла логов доступа (/var/log/httpd/access_log-20260106), размером 7 ГБ. Это привело к заполнению корневой файловой системы на 100%.

### 5. Освобождение дискового пространства

5.1. **Действие**: Удаление проблемного файла.

```bash
sudo rm -rf /var/log/httpd/access_log-20260106
```

5.2. **Результат**: Дисковое пространство восстановлено (доступно более 7 ГБ). Просмотр содержимого директории логов подтвердил успешную очистку.

### 6. Повторная попытка восстановление конфигурационного файла и проверка работоспособности

6.1. **Действие**: Повторное копирование файла настроек.

```bash
cp LocalSettings\ \(5\).php /var/www/html/mediawiki/LocalSettings.php
```

6.2. **Действие**: Проверка размещения файла.

```bash
ls -al /var/www/html/mediawiki/
```

6.3. **Действие**: Перезапуск веб-сервера для применения изменений.

```bash
sudo service httpd restart
sudo service httpd status
```

6.4. **Результат**: Сервис активен (active (running)). Проверка работоспособности в браузере выявила
новую ошибку - некорректный IP-адрес в конфигурации (устаревшее значение, не соответствующее
текущему адресу сервера 18.196.71.81).

### 7. Исправление IP-адреса в конфигурационном файле

7.1. **Действие**: Редактирование файла для исправления устаревшего IP-адреса сервера (замена на актуальный 18.196.71.81).

```bash
sudo nano /var/www/html/mediawiki/LocalSettings.php
```

7.2. **Действие**: Перезапуск веб-сервера для применения изменений.

```bash
sudo service httpd restart
sudo service httpd status
```

7.3. **Результат**: Сервис активен (active (running)). Проверка в браузере подтвердила полную работоспособность: сайт отдает стартовую страницу MediaWiki, переход по ссылкам функционирует стабильно без ошибок.

### 8. Анализ и исправление механизма ротации логов

8.1. **Действие**: Просмотр текущих cron-заданий для выявления причин разрастания логов.

```bash
sudo crontab -l
```

8.2. **Результат**: Обнаружены две проблемы: ежеминутное расписание (`* * * * *`) приводило к
чрезмерной частоте архивации; некорректный путь к архиву вызывал рекурсивное включение предыдущих
бэкапов, что приводило к экспоненциальному росту размера бекапа.

### 9. Создание и настройка скрипта автоматизации ротации логов

9.1. **Действие**: Создание скрипта /home/ec2-user/backup_logs.sh для ежедневной архивации (с хранением 3 последних копий), очистки лога и удаления старых архивов.

```bash
nano backup_logs.sh`
```

Содержимое скрипта:

```bash
#!/bin/bash
LOG_DIR="/var/log/httpd"
LOG_FILE="access_log"
BACKUP_DIR="/home/ec2-user/backup_httpd"
DATE=$(date +%Y%m%d-%H:%M:%S)
ARCHIVE="$BACKUP_DIR/log-httpd-$DATE.tar.gz"

mkdir -p "$BACKUP_DIR"
tar -czf "$ARCHIVE" "$LOG_DIR/$LOG_FILE" > "$LOG_DIR/$LOG_FILE"
find "$BACKUP_DIR" -type f -name "log-httpd-*.tar.gz" -mtime +3 -exec rm {} \;
```

9.2. **Действие**: Присвоение прав на выполнение и тестирование скрипта.

```bash
chmod +x backup_logs.sh
./backup_logs.sh
ls -al backup_httpd/
tar -tf backup_httpd/log-httpd-20260107-*.tar.gz
```

9.3. **Действие**: Многократное тестирование скрипта с проверкой времени и содержимого архивов.

```bash
./backup_logs.sh
ls -al backup_httpd/
```

9.4. **Действие**: Добавление скрипта в cron с ежедневным расписанием (03:05).

```bash
crontab -e
```

Задание в cron:

`5 3 * * * /home/ec2-user/backup_logs.sh`

9.5. **Результат**: Скрипт успешно создает архивы, очищает лог и удаляет старые копии. Тестирование подтвердило корректность работы без рекурсии.

### 10. Финальная проверка и очистка

10.1. **Действие**: Итоговая проверка дискового пространства и логов.

```bash
df -h
ls -alh /var/log/httpd/
```

10.2. **Действие**: Очистка тестовых директорий и выход из сессии.

```bash
rm -rf backup_httpd/
exit
```

10.3. **Результат**: Система стабильна, пространство не исчерпано.

## Устраненные проблемы

В результате инцидента были устранены следующие проблемы:

- Освобождение дискового пространства путем удаления и очистки бэкапов лога доступа.
- Восстановление конфигурационного файла LocalSettings.php из резервной копии с исправлением ошибок (включая актуализацию IP-адреса).
- Оптимизация cron-заданий для автоматизированной ротации логов с предотвращением роста размера файлов архива.

## Ключевые моменты

- Автоматизация ротации логов должна учитывать интервалы выполнения и стратегии хранения для предотвращения накопления данных.
- Регулярный мониторинг дискового пространства критически важен; рекомендуется разработка скрипта для алертов по email или Telegram при превышении 80% загрузки.
- Проверка резервных копий на актуальность и доступность позволяет минимизировать время восстановления.

## Рекомендации по предотвращению

1. Внедрить ежедневные проверки дискового пространства в cron с отправкой сообщения по почте или с
   помощью Telegram бота (например, `df -h | mail -s "Disk Usage Alert" admin@example.com` при превышении 80%).
2. Настроить logrotate как альтернативу кастомному скрипту (конфигурация в /etc/logrotate.d/httpd).
3. Провести аудит всех cron-заданий на сервере для выявления потенциальных конфликтов и оптимизации расписаний.

Данный инцидент был разрешен без потери данных, с общим временем восстановления ~90 мин. Отчет
утвержден: 07/01/2026.
